// ==UserScript==
// @name         PFQ Melan Calculator Timers Bar
// @namespace    http://tampermonkey.net/
// @version      2025-11-01
// @description  adds a button to the timers bar showing your current melan odds, fetched every 5 minutes
// @author       Corviknight https://pfq.link/@Kp
// @match        https://pokefarm.com/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=pokefarm.com
// @grant        GM_xmlhttpRequest
// ==/UserScript==

(function() {
    'use strict';

    window.calculateOdds = function (hypermode,albIndex,sei,longChain,shinyCharm,uberCharm,z,typerace,potd,silverAmulet,goldAmulet,chaincount,minichain) {
        var baseAlbino = 6144;
        const albBoost = [6144, 3072, 1536, 768, 480, 270, 180];
        baseAlbino = albIndex==0 ? Infinity : albBoost[albIndex-1]; //applies boost from alb radar level. 1/inf if not active
        if(silverAmulet) baseAlbino = Math.ceil(baseAlbino/(4/3));
        if(z) baseAlbino = Math.ceil(baseAlbino/1.5); //1.5x albino odds (+50%)
        if(typerace) baseAlbino =Math.ceil(baseAlbino/1.2); //1.2x albino odds (+20%)

        var trueAlbino = baseAlbino; //this point is the actual albino odds, so preserve that
        console.log("Calculated albino odds: 1/" + trueAlbino);

        var baseShiny = 1000;
        if(hypermode) baseShiny = baseShiny/2; //hypermode users will have 1/200
        if(shinyCharm) baseShiny = baseShiny/2.5; //2.5x shiny odds
        if(potd) baseShiny = baseShiny/2; //2x shiny boost
        if(goldAmulet) baseShiny = baseShiny/1.5; //1.5x shiny odds
        var decay = .99 - sei/25 * 0.01; //sei boost now affects decay
        //console.log("decay " + decay);
        console.log("Base shiny odds (minichain 0): 1/" + baseShiny);

        //below is computing average minichain length, ie. average space between shinies or running average shiny odds
        //this is most representative of what you can expect with given boosts
        //individual odds from 0 to 500 are also recorded to access shiny odds at any given minichain
        var odds = [];
        var freq = [];
        var negate = [];
        var exact = [];
        var avglength = 0;
        for(var i=0; i<500; i++) {
            if(i==0) {
                odds.push(baseShiny);
                freq.push(1/Math.ceil(baseShiny));
                exact.push(1/Math.ceil(baseShiny));
                negate.push(1-(1/Math.ceil(baseShiny)));
            }
            else {
                var x = (odds[i-1]-1) * decay + 1;
                var f = (1/Math.ceil(x));
                odds.push(x);
                freq.push(f);
                exact.push(f*negate.reduce((a,b)=>a*b,1));
                negate.push(1-f);
                avglength+=(i+1)*exact[i];
            }
        }
        console.log(odds);
        console.log("Calculated average minichain length (average shiny odds across minichain): 1/" + avglength);

        var success = 100;
        baseAlbino *=100;
        if(uberCharm) success*=6;
        if(longChain!=0) success *= (1+longChain*.01);

        var result = Math.ceil(avglength * Math.ceil(baseAlbino)/Math.ceil(success)); //average melan odds across minichain (utilizing average shiny odds)
        console.log("Calculated average melan odds: 1/" + result);
        document.querySelector("span#calculatedMelanOdds").innerHTML = " 1/"+result;

        localStorage.setItem("0melancalc.results",[Math.ceil(avglength),trueAlbino,result,baseAlbino,success]);
        localStorage.setItem("0melancalc.minichain",minichain);
        localStorage.setItem("0melancalc.shinyodds",JSON.stringify(odds));
        localStorage.setItem("0melancalc.resultstimestamp",Date.now());
    }
    var prevResults = null;
    var prevShinyOdds = null;
    var minichain = null;
    if(localStorage.getItem("0melancalc.results") != null) prevResults = localStorage.getItem("0melancalc.results").split(',');
    if(localStorage.getItem("0melancalc.minichain") != null) minichain = localStorage.getItem("0melancalc.minichain").split(',');
    if(localStorage.getItem("0melancalc.shinyodds") != null) prevShinyOdds = JSON.parse(localStorage.getItem("0melancalc.shinyodds"));
    var timestamp = localStorage.getItem("0melancalc.resultstimestamp");
    const delta = Date.now() - timestamp;
    console.log("Melan odds last fetched (ms): " + delta);

    if(localStorage.getItem("0melancalc.pinleft") == null) localStorage.setItem("0melancalc.pinleft", 0);
    const pin = localStorage.getItem("0melancalc.pinleft");
    const announceul = document.querySelector("#announcements ul");
    const spacer = document.querySelector("#announcements li.spacer");
    const happy = document.getElementById("partypage") == null ? null : document.getElementById("partypage").getElementsByClassName("happy"); //ensures we only get this on the party page, not other users
    const myli = document.createElement("li");
    const type = document.getElementsByClassName("type");

    //append elements showing odds on the party's egg panels
    if(happy!=null){
        const newStyle = document.createElement("style");
        document.head.appendChild(newStyle);
        newStyle.innerHTML = `
    .party > div > .extra {
    display: flex;
    justify-content: space-between;
    }
    `;
        for(var i=0;i<happy.length;i++) {
            if(happy[i].innerHTML.includes("egg.png")) { //check whether we're dealing with an egg on our party page
                type[i].style.width = "unset"; //this gives us a little more space
                const newDiv = document.createElement("div");
                happy[i].after(newDiv); //inserting our new elements after the egg hatch %
                var currMini = parseInt(minichain);
                console.log(prevShinyOdds);
                newDiv.outerHTML = `
<div style="float:left;margin:0 2px;">
<img style="margin:0 2px 0 0" src="https://static.pokefarm.com/img/pkmn/shiny.png">
1/` + (prevResults == null ? " N/A" : Math.ceil(prevShinyOdds[currMini+i])) +
`</div>
<div style="float:left;margin:0 2px;">
<img style="margin:0 2px 0 0" src="https://static.pokefarm.com/img/pkmn/melanistic.png">
1/` + (prevResults == null ? " N/A" : Math.ceil(Math.ceil(prevShinyOdds[currMini+i])*Math.ceil(prevResults[3]/*albino threshold*/) / Math.ceil(prevResults[4] /*success threshold*/))) +
`</div>`;
            }
        }
    }

    //defaults to putting it as the last timer, but has option to put it as the first in config
    if(!(+pin)) { announceul.insertBefore(myli,spacer); } //unary operator + converts to int because localstorage stores as string
    else { announceul.prepend(myli); }

    // you have to insert it before you can change outerhtml for whatever reason
    myli.outerHTML = `
    <li data-name="melancalc" style="cursor: pointer;"><a title="Melanistic Calculator"><img src="https://pokefarm.com/upload/:Kp/melan_calc_star.png" alt="Melanistic Calculator"><span id="calculatedMelanOdds">` + (prevResults == null ? " N/A" : " 1/" + prevResults[2]) + `</span> </a></li>
    `;
    if (localStorage.getItem("0melancalc.key") != null) {
        if(delta>10000) { //wait 10 seconds between requests
        //gotta do it with tampermonkey's special xml method to avoid cors killing me
        //it'll come up with a screen asking the user for permission the first time
        GM_xmlhttpRequest ({
            method: "GET",
            url: "https://api.pokefarm.com/v1/user/boosts",
            headers: {
                "x-api-key": localStorage.getItem("0melancalc.key")
            },
            onload: function (response) { //once we get API data, auto-apply it
                console.log(response.responseText);
                var values = JSON.parse(response.responseText).boosts;
                console.log(values);
                if(this.status == 500) {
                    //this is probably happening because the user doesn't currently have a chain at all, the api doesn't handle it right
                    //we can't get status of other things like albino charge because of this, even though there is a theoretical melan chance
                    console.log("Status code 500, is there an active chain? (API doesn't return data when there is no chain)");
                    return;
                }
                else if(this.status != 200) {
                    console.log("API key incorrect or site timeout, status code: " + this.status)
                    document.querySelector("span#calculatedMelanOdds").innerHTML = " Invalid key";
                    //document.getElementById("apierrortext").innerHTML += "<br><br>API key incorrect or site error; please re-enter API key or try again later.";
                    return;
                } //key is incorrect, timeout, etc

                var cobaltBoost = !values.cobaltAmulet ? 0 // if no cobalt amulet, long chain boost = 0
                : values.shinyChainCount <=5000 ? (values.shinyChainCount - (values.shinyChainCount%100))/100 * 2 // if you have amulet and you're <= 5000 eggs, calculate boost
                : 100; // if you have amulet and over 5000 eggs, cap at 100
                window.calculateOdds(values.hypermode,values.albinoLevel,values.seiPower,cobaltBoost,values.shinyCharm,values.uberCharm,values.zCrystal,values.typeRace,values.potd,values.silverAmulet,values.goldAmulet,values.shinyChainCount,values.shinyChainSubchain);
            }

        });
        }
    }
    else { //get user to update their api key
        document.querySelector("span#calculatedMelanOdds").innerHTML = " Click to set up";
    }
    document.querySelector(`li[data-name="melancalc"]`).addEventListener('click', function() {
        //get updated timestamp b/c this is loaded asynchronously
        timestamp = localStorage.getItem("0melancalc.resultstimestamp");

        const configele = document.createElement("div");
        document.body.appendChild(configele);
        var curresults = localStorage.getItem("0melancalc.results");
        configele.outerHTML = `
    <div class="melancalc dialog">
    <div><div><div style="margin-top: 1em; margin-bottom: 1em;"><h3>Melanistic Calculator Configuration</h3>
    <div><h4 style="margin:5px 0">API Key Entry</h4>You can find or generate your PFQ API key <a href="https://pokefarm.com/farm#tab=5.7">here</a>. Reload the page for the change to take effect.
    <br><input id="apikey" type="text" autocomplete="off"><button id="apibutton">Add</button>
    <hr>
    <h4 style="margin:5px 0">Options</h4>
    Reload the page to apply new settings.
    <br><br>
    <input type="checkbox" id="pinleftcheck"` + (+localStorage.getItem("0melancalc.pinleft") != 0 ? "checked" : "" ) + `> Pin to first in timers bar
    <hr>
    <h4 style="margin:5px 0">Known bug:</h4> The Type Race albino bonus may be incorrectly applied while Type Race is not currently taking place. This is due to an error with PFQ's API. Please be patient while we wait for this to be fixed.
    <br><br>For other functionality, try visiting <a href="https://lumiet.github.io/pfq/melancalc/">my calculator offsite</a>. Please report any issues <a href="https://pokefarm.com/pm/send/:Kp">via PM</a>.`
            +
            "<br><br>To ease server load, API data is fetched every 5 minutes. Use the refresh button below to fetch the most current data.<br>Last calculated: " + (timestamp!=null ? (new Date(+timestamp)) : "N/A")
            +
            (curresults != null ?
             "<br><br>Shiny odds: 1/" + curresults.split(',')[0] + "<br>Albino odds: 1/" + curresults.split(',')[1] : "")
            +
            `<br><button id="refreshcalc" type="button" style="margin: 8px 0 0 0;">Refresh Data</button>
            <button id="closecalcconfig" type="button" style="float: right; margin: 8px 0 0 0;">Close</button></div>
    </div></div></div></div>
    `;
        document.querySelector("#pinleftcheck").addEventListener('change', function() {
           if(document.querySelector("#pinleftcheck").checked) {
               localStorage.setItem("0melancalc.pinleft", 1);
           }
           else {
               localStorage.setItem("0melancalc.pinleft", 0);
           }
        });
        const apisubmit = document.querySelector("#apibutton");
        apisubmit.addEventListener('click', function() {
            apisubmit.innerHTML = "Added!";
            localStorage.setItem("0melancalc.key", document.querySelector("#apikey").value);
        });
        document.querySelector("#closecalcconfig").addEventListener('click', function() {
            document.querySelector("div.melancalc").remove();
            document.querySelector("#core").classList.remove('scrolllock');
        });
        document.querySelector("#refreshcalc").addEventListener('click', function() {
            //removing these from localstorage will force it to recall on refresh
            localStorage.removeItem("0melancalc.results");
            localStorage.removeItem("0melancalc.resultstimestamp");
            document.querySelector("#refreshcalc").innerHTML = "Refreshing...";
            location.reload();
        });
        document.querySelector("#core").classList.add('scrolllock');
    });


})();