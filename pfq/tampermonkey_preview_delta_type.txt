// ==UserScript==
// @name         Preview Delta Type
// @namespace    http://tampermonkey.net/
// @version      2025-09-01
// @description  Adds an option to the Pokemon menu to preview a different Delta type
// @author       Corviknight https://pfq.link/@Kp
// @match        https://pokefarm.com/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=pokefarm.com
// @grant        GM_xmlhttpRequest
// ==/UserScript==
(function() {
    'use strict';
    const allowedPaths = [
        /^\/summary\/[^/]+$/,
        /^\/party$/
    ];

    if (!allowedPaths.some(pattern => pattern.test(location.pathname))) return;
// fetch call cannot be used in tampermonkey due to CORS, this is for release version
    /*const checkImageExists = async function(url, target, base, type) {
        // for fetching corresponding hex color from type
        // grabbed from Mirzam's css and converted from rgb to hex (thank you!)
        const typeHex = {
            "normal": "#A8A878",
            "fire": "#F08030",
            "water": "#6890F0",
            "electric": "#F8D030",
            "grass": "#78C850",
            "ice": "#98D8D8",
            "fighting": "#C03028",
            "poison": "#A040A0",
            "ground": "#E0C068",
            "flying": "#A890F0",
            "psychic": "#F85888",
            "bug": "#A8B820",
            "rock": "#B8A038",
            "ghost": "#705898",
            "dragon": "#7038F8",
            "dark": "#705848",
            "steel": "#B8B8D0",
            "fairy": "#FF65D5"
        };
        // split on " character to separate out url("url...") into just url
        // due to css formatting
        let res = await fetch(url.split("\"")[1]);
        if(res.status!=200) {
            target.style.backgroundImage = base;
            // drop shadow values also grabbed from Mirzam
            target.style.filter = `drop-shadow(0px 1px 0px ${typeHex[type]})
    drop-shadow(-1px 0px 0px ${typeHex[type]})
    drop-shadow(1px 0px 0px ${typeHex[type]})
    drop-shadow(0px 0px 1px ${typeHex[type]})
    drop-shadow(0px -2px 1px ${typeHex[type]})`;
            document.querySelector("div.changedelta").remove();
            document.querySelector("#core").classList.remove('scrolllock');

        }
        else {
            target.style.backgroundImage = url;
            target.style.filter = "";
            document.querySelector("div.changedelta").remove();
            document.querySelector("#core").classList.remove('scrolllock');
        }

    };*/
// only redefining for tampermonkey script below, not necessary for release script
            const typeHex = {
            "normal": "#A8A878",
            "fire": "#F08030",
            "water": "#6890F0",
            "electric": "#F8D030",
            "grass": "#78C850",
            "ice": "#98D8D8",
            "fighting": "#C03028",
            "poison": "#A040A0",
            "ground": "#E0C068",
            "flying": "#A890F0",
            "psychic": "#F85888",
            "bug": "#A8B820",
            "rock": "#B8A038",
            "ghost": "#705898",
            "dragon": "#7038F8",
            "dark": "#705848",
            "steel": "#B8B8D0",
            "fairy": "#FF65D5"
        };

    const optionHtml = `
    <hr>
    <label id="changeDelta">Preview Delta Type</label>
    `;
    const newHtml = document.createElement("div");

    //we grab these elements because i want to put our new html right after them
    const menus = document.querySelectorAll(`[data-menu="explock"]`);

    //this loop is just for adding the new html to the menu on each pokemon
    for(var i = 0; i<menus.length; i++) {
        menus[i].after(newHtml);
        newHtml.outerHTML = optionHtml;
    }
    //now we query our new label we inserted and add event listeners to each
    const labels = document.querySelectorAll("label#changeDelta");
    for(var j=0;j<labels.length;j++) {
        labels[j].addEventListener("click", function (e) {
            //grabbing the target div with background image to modify
            const targetEle = this.parentElement.parentElement.querySelector(".pkmn").querySelector(".pokemon");
            //close the menu once an option is selected
            const currMenu = this.parentElement.parentElement;
            currMenu.classList.remove('menu');

            //create the dialogue where you can choose which delta type to preview
            const dialogue = document.createElement("div");
            document.querySelector("#core").classList.add("scrolllock");
            document.body.appendChild(dialogue);
            dialogue.outerHTML = `
         <div class="changedelta dialog">
         <div>
         <div>
         <div>
         <h3>Preview Delta Type</h3>
         <div>
         <p>Select a Delta Type to preview: <select id="delta-type-select">
         <option value="none">None</option>
         <option value="normal">Normal</option>
         <option value="fire">Fire</option>
         <option value="water">Water</option>
         <option value="electric">Electric</option>
         <option value="grass">Grass</option>
         <option value="ice">Ice</option>
         <option value="fighting">Fighting</option>
         <option value="poison">Poison</option>
         <option value="ground">Ground</option>
         <option value="flying">Flying</option>
         <option value="psychic">Psychic</option>
         <option value="bug">Bug</option>
         <option value="rock">Rock</option>
         <option value="ghost">Ghost</option>
         <option value="dragon">Dragon</option>
         <option value="dark">Dark</option>
         <option value="steel">Steel</option>
         <option value="fairy">Fairy</option>
         </select>
         </p>
         <button type="button" id="selectdelta" style="margin: 0px 8px 0px 0px;">Select</button><button type="button" id="closechangedelta" style="float: right; margin: 0px 0px 0px 8px;" data-cancelbutton="1">Cancel</button></div></div></div></div></div>
         `;

            //wait for user to close or select delta type, then act accordingly
            document.querySelector("#closechangedelta").addEventListener("click", function() {
                document.querySelector("div.changedelta").remove();
                document.querySelector("#core").classList.remove('scrolllock');
            });

            document.querySelector("#selectdelta").addEventListener("click", function() {
                //grab our selected value
                const selectedType = document.querySelector("#delta-type-select").value;
                //grab existing background image url to manipulate
                //also grab from static rather than r2, necessary as of 7/9/2025 server migration
                var url = targetEle.style.backgroundImage.replace("r2","static");
                var noDeltaUrl = "";
                //regex time
                //example URLs:
                //https://static.pokefarm.com/img/pkmn/o/o/g/delta-water.png/t=1750511298.png
                //https://static.pokefarm.com/img/pkmn/o/o/g.png/t=1750511298.png
                //token at the end is not required for our purposes

                if(url.includes("delta")) { //image we're manipulating already is a delta
                    noDeltaUrl = url.replace(/\/delta-.*/,'') + `.png")`;
                    if(selectedType == "none") { //then we want to make this delta into the normal image
                        url = url.replace(/\/delta-.*/,'') + `.png")`;
                    }
                    else { //then we want to change this delta into a different delta type
                        url = url.replace(/delta-.*/,'delta-' + selectedType) + `.png")`;
                    }
                }
                else { //image we're manipulating is not a delta yet
                    noDeltaUrl = url;
                    if(selectedType != "none") { //if they want to add a type
                        url = url.replace(/\.png.*/,`/delta-`+ selectedType + `.png")`);
                    }
                }

                GM_xmlhttpRequest ({
                    method: "GET",
                    // split on " character to separate out url("url...") into just url
                    // due to css formatting
                    url: url.split("\"")[1],
                    onload: function (response) {
                        //console.log(response);
                        if(this.status != 200) {
                            //console.log("status code: " + this.status);
                            targetEle.style.backgroundImage = noDeltaUrl;
                            // drop shadow values also grabbed from Mirzam
                            targetEle.style.filter = `drop-shadow(0px 1px 0px ${typeHex[selectedType]})
    drop-shadow(-1px 0px 0px ${typeHex[selectedType]})
    drop-shadow(1px 0px 0px ${typeHex[selectedType]})
    drop-shadow(0px 0px 1px ${typeHex[selectedType]})
    drop-shadow(0px -2px 1px ${typeHex[selectedType]})`;
                            document.querySelector("div.changedelta").remove();
                            document.querySelector("#core").classList.remove('scrolllock');
                        }
                        else {
                            //console.log("status code: " + this.status);
                            targetEle.style.backgroundImage = url;
                            targetEle.style.filter = "";
                            document.querySelector("div.changedelta").remove();
                            document.querySelector("#core").classList.remove('scrolllock');
                        }
                    }

                });

                //checkImageExists(url, targetEle, noDeltaUrl, selectedType);
            });

        });
    }

})();